<template lang="pug">
  v-form
    form(enctype="multipart/form-data")
      v-btn(icon, @click="open", flat, fab color="success")
        v-icon(large) {{ icon }}
      input(v-if='!hidden', type="file", accept="*", name="files", @change="fileChange", ref="file_input", :multiple='multiple', hidden)
      small {{ help }}
      slot
      div(v-if='active')
        v-btn(v-on:click='send') OK
        v-btn(v-on:click='reset') Annuler
        v-progress-circular(:value='loaded' v-if='onUpload' color='primary')
      Alert(v-on:done="alertEnd" transitionName="slide-y-transition", :alertType="alertType", outlineMode=false, :visibility="alert", durationTime="2000")
        span {{ alertMsg }}
</template>

<script>
import axios from 'axios'
import Alert from '../Alert/Alert.vue'
export default {
  name: 'FileUpload',
  components: {
    Alert },
  props: ['endpoint', 'help', 'icon', 'extras', 'disabled', 'hidden', 'multiple'],
  data () {
    return {
      loaded: 0,
      onUpload: false,
      files: null,
      active: false,
      alertType: 'error',
      alertMsg: '',
      alert: false,
      errorCode: ''
    }
  },
  methods: {
    open () {
      this.$refs.file_input.click()
    },
    fileChange (e) {
      this.active = !this.active
      if (e.target.files[0]) {
        this.files = e.target.files
      }
    },
    reset () {
      this.files = null
      this.active = false
      this.loaded = 0
      this.onUpload = false
      this.$refs.file_input.value = null
    },
    send () {
      const formdata = new FormData()
      formdata.append('extras', JSON.stringify(this.extras))
      for (let i = 0; i < this.files.length; i++) {
        formdata.append('files[]', this.files[i])
      }
      const self = this

      axios.put(this.endpoint, formdata, {
        onUploadProgress (e) {
          self.onUpload = true
          self.loaded = Number(Math.round((100 * e.loaded) / e.total))
        }
      }).then(response => {
        this.reset()
        this.alert = true
        if (response.data.error.length < 1) {
          this.alertType = 'success'
          this.alertMsg = 'Fichier(s) envoyÃ©'
        } else {
          this.alertType = 'error'
          this.alertMsg = 'Une erreur est survenue'
          this.errorCode = response.data.error
        }
        this.$emit('response', response.data)
      })
    },
    alertEnd () {
      this.alert = false
    }
  }
}
</script>

<style scoped>

</style>
